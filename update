#!/usr/bin/env python2

import sys
import os
import subprocess

# First run my latex script
LSCRIPT = "/home/gibson/jonask/SVN/cindex_bsi/latexhooks/scripts/latex_publish_diff.sh"

out = subprocess.check_output([LSCRIPT, sys.argv[1],
                               sys.argv[2], sys.argv[3]])

results = out.strip().split('\n')
# The links are last
pdf = results[-4]
pdfdiff = results[-3]
gitdiff = results[-2]
gitlog = results[-1]

# If necessary, add the path to the directory containing
# git_multimail.py to the Python path as follows.  (This is not
# necessary if git_multimail.py is in the same directory as this
# script):

LIBDIR = './scripts/git-multimail'
sys.path.insert(0, LIBDIR)

import git_multimail


# It is possible to modify the output templates here; e.g.:

#git_multimail.FOOTER_TEMPLATE = """\
#
#-- \n\
#This email was generated by the wonderful git-multimail tool.
#"""

git_multimail.NEW_REVISIONS_TEMPLATE = """\
The %(tot)s revisions listed above as "new" are entirely new to
this repository.  The revisions listed as "adds" were already present
in the repository and have only been added to this reference.

For your convenience, a pdf of the latex source as well as a
latexdiff pdf is available here:

LaTeX PDF : {pdfurl}
LaTeX DIFF: {pdfdiffurl}
GIT DIFF  : {gitdiffurl}
GIT LOG   : {gitlogurl}

""".format(pdfurl=pdf, pdfdiffurl=pdfdiff,
           gitdiffurl=gitdiff, gitlogurl=gitlog)


# Specify which "git config" section contains the configuration for
# git-multimail:
config = git_multimail.Config('multimailhook')

# Select the type of environment:
environment = git_multimail.GenericEnvironment(config=config)
#environment = git_multimail.GitoliteEnvironment(config=config)

# Choose the method of sending emails based on the git config:
mailer = git_multimail.choose_mailer(config, environment)

# Read changes from stdin and send notification emails:
#git_multimail.run_as_post_receive_hook(environment, mailer)
git_multimail.run_as_update_hook(environment, mailer, sys.argv[1],
                                 sys.argv[2], sys.argv[3])
